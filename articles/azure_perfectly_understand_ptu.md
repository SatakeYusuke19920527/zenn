---
title: "【Azure OpenAI】PTUについて完全に理解する【2024年8月14日最新版】"
emoji: "🚀"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Azure", "OpenAI","Microsoft", "PTU", "AOAI"]
published: false
publication_name: "microsoft"
---

![Azure](/images/azure_perfectly_understand_ptu/img1.png)

# 本記事の目標はPTU(Provisioned throughput units)について完全に理解することです🚀

本記事では、Azure OpenAIを利用する上で理解しておくべき概念である **PTU** について、完全に理解する為の記事です。
**PTU** とは何か、どのように活用できるのか、利用するとどのようなメリットがあるのか詳細に解説します。

また、Azure OpenAI の PTUは、購入モデルと Azure 標準との調整や、モデルに依存しないクォータへの移行を含めて、2024 年 8 月 12 日に大規模な更新がありました。
本記事はこの更新によって何が変わるのかも記載したいと思います。

## 目次

1. [PTUとは何か？](#ptuとは何か)
2. [PTUが使用出来るモデルとリージョン](#PTUが使用出来るモデルとリージョン)
3. [PTUの仕組み](#ptuの仕組み)
4. [PTUの利用方法](#ptuの利用方法)
5. [PTUのベストプラクティス](#ptuのベストプラクティス)
6. [PTUとコスト管理](#ptuとコスト管理)
7. [まとめ](#まとめ)

## PTUとは何か？

### 定義と役割

**PTU（Provisioned Throughput Units）**とは、Azure OpenAIサービスで使用される単位で、指定されたスループット（一定時間内に処理できるリクエストの量）を予約する仕組みのことです。
Azure VMで言うところのリザーブドインスタンスみたいな感じですね。

PTUを利用することで、スケーラブルなAIサービスを提供し、リクエストの高負荷時にも安定したパフォーマンスを維持することができます。

**PTU**で処理能力を事前に予約することで、応答速度の向上と安定稼働を実現することが出来、主なメリットとして以下のような点があります。


| メリット | 解説 |
| ---- | ---- |
| **予測可能なパフォーマンス** | Azure OpenAIをDeployした処理リソースの占有的な利用が可能なので、均一なワークロードに対して安定した最大待ち時間とスループットを出すことが出来る |
| **予約済み処理機能** | 処理能力を事前に予約することが出来るので、応答速度の向上と安定稼働を実現することが出来る |
| **コスト削減** | 高速なレスポンスや高い可用性が求められる用途に適しているPTUは、高スループットワークロードを実現出来、トークンベースの使用と比較したときのコスト削減につながる場合がある |


要するに、**PTU**を使うことで、パフォーマンスが安定出来、普通に使うよりコスト的にも抑えることが出来るというものです。


### 背景と必要性

通常、Azureのようなクラウドサービスでは、リクエストの量に応じて自動的にリソースがスケールされます。

しかし、急にリクエストが増えると、対応が遅れたり、パフォーマンスが低下することがあります。

そこでPTUを使うと、事前に1秒あたりの処理リクエスト数（スループット）を予約しておくことができるので、リクエストが集中しても安定したパフォーマンスを保てます。

なので、AIサービスの提供者は予測可能なパフォーマンスを確保するために、PTUを活用することが重要です。

## PTUが使用出来るモデルとリージョン

PTUが利用出来るモデルとリージョンは以下の通りです。
リージョン毎にPTUが使えないモデルもあるので、契約時点ではよく確認してから契約する必要がありそうです。

- **PTUが使用出来るモデルとリージョン一覧**

| リージョン | gpt-4、0613 | gpt-4、1106-Preview | gpt-4、0125-Preview | gpt-4、turbo-2024-04-09 | gpt-4o、2024 年 5 月 13 日 | gpt-4-32k、0613 | gpt-35-turbo、1106 | gpt-35-turbo、0125 |
|-------------------------|-------------|---------------------|---------------------|-------------------------|--------------------------|------------------|---------------------|---------------------|
| australiaeast            | ✅          | ✅                  | ✅                  | ✅                      | ✅                       | ✅               | ✅                  | ✅                  |
| brazilsouth              | ✅          | ✅                  | ✅                  | -                       | ✅                       | ✅               | ✅                  | -                   |
| canadacentral            | ✅          | -                   | -                   | -                       | -                        | ✅               | -                   | ✅                  |
| canadaeast               | ✅          | ✅                  | -                   | ✅                      | ✅                       | -                | ✅                  | -                   |
| eastus                   | ✅          | ✅                  | ✅                  | ✅                      | ✅                       | ✅               | ✅                  | ✅                  |
| eastus2                  | ✅          | ✅                  | ✅                  | ✅                      | ✅                       | ✅               | ✅                  | ✅                  |
| francecentral            | ✅          | ✅                  | ✅                  | -                       | ✅                       | ✅               | -                   | ✅                  |
| germanywestcentral       | ✅          | ✅                  | ✅                  | ✅                      | ✅                       | ✅               | ✅                  | -                   |
| japaneast                | -           | ✅                  | ✅                  | ✅                      | ✅                       | -                | -                   | ✅                  |
| koreacentral             | ✅          | -                   | -                   | ✅                      | ✅                       | ✅               | ✅                  | -                   |
| northcentralus           | ✅          | ✅                  | ✅                  | ✅                      | ✅                       | ✅               | ✅                  | ✅                  |
| norwayeast               | ✅          | -                   | ✅                  | -                       | -                        | ✅               | -                   | -                   |
| polandcentral            | ✅          | ✅                  | ✅                  | -                       | -                        | ✅               | ✅                  | ✅                  |
| southafricanorth         | ✅          | ✅                  | -                   | ✅                      | -                        | ✅               | ✅                  | -                   |
| southcentralus           | ✅          | ✅                  | ✅                  | ✅                      | ✅                       | ✅               | ✅                  | ✅                  |
| southindia               | ✅          | ✅                  | ✅                  | -                       | ✅                       | ✅               | ✅                  | ✅                  |
| swedencentral            | ✅          | ✅                  | ✅                  | ✅                      | ✅                       | ✅               | ✅                  | ✅                  |
| switzerlandnorth         | ✅          | ✅                  | ✅                  | ✅                      | ✅                       | ✅               | ✅                  | ✅                  |
| switzerlandwest          | -           | -                   | -                   | -                       | -                        | -                | -                   | ✅                  |
| uksouth                  | ✅          | ✅                  | ✅                  | ✅                      | ✅                       | ✅               | ✅                  | ✅                  |
| westus                   | ✅          | ✅                  | ✅                  | ✅                      | ✅                       | ✅               | ✅                  | ✅                  |
| westus3                  | ✅          | ✅                  | ✅                  | ✅                      | ✅                       | ✅               | ✅                  | ✅                  |



## PTUの仕組み
### スケーリングと負荷分散

PTUは自動スケーリングの一環として機能し、リクエストの負荷に応じて動的にスケールアップまたはダウンすることができます。また、複数のPTUを使用することで、負荷分散が可能になり、パフォーマンスの向上が期待できます。

## PTUの利用方法

### 設定方法

PTUの設定は、Azure PortalまたはCLIを使用して簡単に行うことができます。設定時には、必要なスループット量を予測し、それに応じたPTU数を選択します。詳細な設定手順については、[公式ドキュメント](https://learn.microsoft.com/ja-jp/azure/ai-services/openai/concepts/provisioned-throughput)を参照してください。

### 管理とモニタリング

PTUの利用状況は、Azure Monitorを使用してリアルタイムでモニタリングすることができます。これにより、パフォーマンスのトレンドを分析し、必要に応じてPTUの調整が可能です。

## PTUのベストプラクティス

### 最適なPTUの選定

PTUを選定する際は、予測されるトラフィック量を基に、適切なスループットを確保することが重要です。過剰なPTUの選定はコストを増大させるため、ビジネスニーズに合った適切な規模を選ぶことが求められます。

### コストとパフォーマンスのバランス

PTUのコストは、選択したスループット量に依存します。効率的なコスト管理を行うためには、利用状況に応じてPTUをスケーリングし、無駄のないリソース利用を目指すことが重要です。

## PTUとコスト管理

### コストの可視化と予算管理

PTUを利用することで、コストの可視化が容易になります。Azure Cost Managementを使用して、PTUの利用に伴うコストを追跡し、予算内での運用が可能です。

### オプティマイゼーション戦略

コストを最適化するためには、リクエストのパターンに応じてPTUを動的に調整することが効果的です。ピーク時のスループットを正確に見積もり、必要以上のPTUを割り当てないことがコスト削減のポイントです。

## まとめ

PTUは、Azure OpenAIにおいて重要な役割を果たす要素です。適切なPTUの設定と管理を行うことで、スケーラブルかつコスト効率の高いAIサービスの提供が可能になります。この記事を参考に、PTUの理解を深め、Azure OpenAIを最大限に活用してください。

## 参考資料
- [プロビジョニングされたスループットとは](https://learn.microsoft.com/ja-jp/azure/ai-services/openai/concepts/provisioned-throughput) 
- [Azure OpenAI プロビジョニング 2024 年 8 月の更新プログラム](https://learn.microsoft.com/ja-jp/azure/ai-services/openai/concepts/provisioned-migration)
- [Azure OpenAI で API 管理による PTU/TPM を使用する - スケーリングの特別なソースを使用する](https://github.com/Azure/aoai-apim/blob/main/README.md)